<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RTKAv2 Command Center</title>
    <style>
        /* --- ROOT VARIABLES & BASIC SETUP --- */
        :root { 
            --primary: #00ff00; 
            --danger: #ff3333; 
            --dark: #121212; 
            --panel: #1e1e1e; 
            --glass: rgba(0, 0, 0, 0.7); 
            --btn-bg: #333; 
        }
        body { 
            font-family: 'Segoe UI', Consolas, sans-serif; 
            background-color: var(--dark); 
            color: white; 
            margin: 0; padding: 0; 
            height: 100vh; 
            display: flex; flex-direction: column; 
            overflow: hidden; 
            touch-action: none; 
            user-select: none; 
        }
        
        /* --- HEADER --- */
        header { 
            background: #000; 
            padding: 5px 10px; 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid #333; 
            height: 40px; 
        }
        .conn-box { display: flex; gap: 5px; }
        input.ip-input { 
            background: #222; border: 1px solid #444; color: var(--primary); 
            width: 110px; text-align: center; border-radius: 4px; font-family: monospace; 
        }
        button.btn { 
            background: #333; color: white; border: 1px solid #555; 
            padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; 
        }
        button.btn-connect { background: #004400; }
        
        /* --- VIEWPORT (CAMERA) --- */
        #viewport { 
            flex: 1; position: relative; background: #000; 
            display: flex; justify-content: center; align-items: center; overflow: hidden; 
        }
        #cam-feed { width: 100%; height: 100%; object-fit: contain; display: none; }
        .hud { 
            position: absolute; pointer-events: none; padding: 5px; 
            background: var(--glass); border-radius: 4px; font-size: 0.8rem; 
        }
        .hud-tl { top: 10px; left: 10px; color: var(--primary); }
        .hud-tr { top: 10px; right: 10px; text-align: right; }
        
        /* --- CONTROLS PANEL --- */
        #controls { 
            height: 230px; background: var(--panel); 
            display: grid; grid-template-columns: 1fr 1.6fr 1fr; 
            padding: 10px; gap: 10px; 
        }
        .col-joy, .col-center, .col-action { 
            display: flex; justify-content: center; align-items: center; 
        }
        .col-center { flex-direction: column; gap: 10px; }
        .panel-box { 
            background: #2a2a2a; padding: 8px; border-radius: 8px; 
            border: 1px solid #444; width: 98%; box-sizing: border-box; 
        }
        select { 
            width: 100%; background: #333; color: white; 
            padding: 8px; border: none; border-radius: 4px; margin-bottom: 5px; 
        }
        
        /* --- AI BUTTONS GRID --- */
        .ai-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 100%; }
        .btn-ai { 
            background: #444; color: #ccc; border: 1px solid #555; 
            padding: 10px; border-radius: 4px; cursor: pointer; 
            font-size: 0.75rem; text-align: center; 
        }
        .btn-ai.active { 
            background: var(--primary); color: black; font-weight: bold; 
            border-color: #fff; box-shadow: 0 0 5px var(--primary); 
        }

        /* --- SENSOR TOGGLE BUTTONS (KECIL) --- */
        .btn-sensor { 
            flex: 1; padding: 5px 0; font-size: 0.7rem; 
            background: #222; color: #666; 
            border: 1px solid #444; border-radius: 4px; cursor: pointer; 
        }
        .btn-sensor.active { 
            background: var(--primary); color: black; font-weight: bold; 
            box-shadow: 0 0 5px var(--primary); 
        }

        /* --- COLOR SPECIFIC BUTTONS --- */
        .btn-red { border-left: 5px solid red; }
        .btn-green { border-left: 5px solid lime; }
        .btn-blue { border-left: 5px solid blue; }
        .btn-yellow { border-left: 5px solid yellow; }

        /* --- TOGGLE SWITCH (DIGITAL) --- */
        .switch-container { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px; padding: 10px; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(26px); }
        .switch-label { font-weight: bold; color: #aaa; font-size: 0.9rem; }
        input:checked ~ .switch-label { color: var(--primary); text-shadow: 0 0 5px var(--primary); }

        /* --- JOYSTICK UI --- */
        #zone { 
            width: 150px; height: 150px; 
            background: rgba(255, 255, 255, 0.05); 
            border: 2px dashed #444; border-radius: 50%; position: relative; 
        }
        #knob { 
            width: 50px; height: 50px; 
            background: rgba(0, 255, 0, 0.2); 
            border: 2px solid var(--primary); border-radius: 50%; 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
        }
    </style>
</head>
<body>

<header>
    <div style="font-weight:bold; color:var(--primary)">RASPBOT <span style="font-size:0.7em; color:#888">RTKAv2</span></div>
    <div class="conn-box">
        <input type="text" id="ip" class="ip-input" value="192.168.1.101">
        <button id="btn-conn" class="btn btn-connect" onclick="toggleMainConnect()">CONNECT</button>
    </div>
</header>

<div id="viewport">
    <div id="placeholder-text" style="color:#666">SELECT MODE & CONNECT</div>
    <img id="cam-feed" alt="Stream">
    <div class="hud hud-tl">
        <div>MODE: <span id="mode-display" style="color:#fff">READY</span></div>
        <div id="ai-status" style="font-size:0.8em; color:yellow; display:none">STANDBY</div>
    </div>
    <div class="hud hud-tr" id="status-text" style="color:red">DISCONNECTED</div>
</div>

<div id="controls">
    <div class="col-joy">
        <div id="zone"><div id="knob"></div></div>
    </div>

    <div class="col-center">
        <div class="panel-box">
            <select id="opMode" onchange="changeMode()">
                <option value="/ws/control">Remote Control</option>
                <option value="/ws/avoid">Avoid & Follow</option>
                <option value="/ws/tracking">Target Tracking</option>
                <option value="/ws/recognitionControl">Recognition Control</option>
                <option value="/ws/objectDetection">Object Detection</option>
                <option value="/ws/qr">QR Scanner</option>
                <option value="/ws/autoPilot">Auto Pilot</option>
            </select>
        </div>

        <div class="panel-box" id="feature-box" style="display:none; overflow-y:auto; max-height:140px;">
            <label id="feature-label" style="font-size:0.7rem; color:#aaa; margin-bottom:5px; display:block">SELECT FEATURE</label>
            
            <div id="panel-avoid" class="ai-grid" style="display:none; grid-template-columns: 1fr;">
                <button class="btn-ai" onclick="triggerAI('avoid_hcsr', this)" style="margin-bottom:5px; background:#444;">OBSTACLE (ROAMING)</button>
                
                <div style="border-top:1px dashed #555; margin:5px 0;"></div>
                
                <div style="display:flex; justify-content:space-between; gap:2px; margin-bottom:5px;">
                    <button id="s-ll" class="btn-sensor" onclick="toggleSensor('ll')">LL</button>
                    <button id="s-l"  class="btn-sensor" onclick="toggleSensor('l')">L</button>
                    <button id="s-m"  class="btn-sensor" onclick="toggleSensor('m')">M</button>
                    <button id="s-r"  class="btn-sensor" onclick="toggleSensor('r')">R</button>
                    <button id="s-rr" class="btn-sensor" onclick="toggleSensor('rr')">RR</button>
                </div>

                <button class="btn-ai" onclick="triggerLineAvoid(this)" style="background:#004400; border:1px solid #00ff00;">START HYBRID MODE</button>
            </div>
            
            <div id="panel-tracking" class="ai-grid" style="display:none; grid-template-columns: 1fr 1fr 1fr 1fr;">
                <button class="btn-ai" onclick="triggerAI('face_track', this)" style="grid-column: span 4; margin-bottom:5px">FACE TRACKING</button>
                <button class="btn-ai btn-red" onclick="triggerColorTrack('red', this)">RED</button>
                <button class="btn-ai btn-green" onclick="triggerColorTrack('green', this)">GRN</button>
                <button class="btn-ai btn-blue" onclick="triggerColorTrack('blue', this)">BLU</button>
                <button class="btn-ai btn-yellow" onclick="triggerColorTrack('yellow', this)">YEL</button>
                <button id="btn-track-none" class="btn-ai" onclick="triggerAI('none', this)" style="grid-column: span 4; background: #333; border: 1px dashed #666; color: #888;">NONE (STANDBY)</button>
            </div>
            
            <div id="panel-recog" class="ai-grid" style="display:none; grid-template-columns: 1fr 1fr 1fr;">
                <button class="btn-ai" onclick="triggerAI('gesture_cmd', this)" style="grid-column: span 3; margin-bottom:5px">GESTURE COMMAND</button>
                <button class="btn-ai btn-red" onclick="triggerColor('red', this)">RED</button>
                <button class="btn-ai btn-green" onclick="triggerColor('green', this)">GRN</button>
                <button class="btn-ai btn-blue" onclick="triggerColor('blue', this)">BLU</button>
                <button class="btn-ai btn-yellow" onclick="triggerColor('yellow', this)" style="grid-column: span 3;">YELLOW</button>
            </div>

            <div id="panel-detect" class="ai-grid" style="display:none">
                <button class="btn-ai" onclick="triggerAI('object_detection', this)">OBJECT</button>
                <button class="btn-ai" onclick="triggerAI('face_detection', this)">FACE</button>
                <button class="btn-ai" onclick="triggerAI('color_detection', this)">COLOR</button>
                <button class="btn-ai" onclick="triggerAI('gesture_recognition', this)">GESTURE</button>
            </div>

             <div id="panel-single" style="display:none; width:100%;">
                <div class="switch-container">
                    <label class="switch">
                        <input type="checkbox" id="system-switch" onchange="toggleSystem(this)">
                        <span class="slider round"></span>
                    </label>
                    <div id="switch-txt" class="switch-label">SYSTEM OFF</div>
                </div>
            </div>
        </div>

        <div class="panel-box" id="speed-box">
            <label style="font-size:0.7rem; color:#aaa;">MAX SPEED</label>
            <input type="range" id="speed" min="0" max="100" value="100" style="width:100%">
        </div>
    </div>

    <div class="col-action">
        <button style="width:80px; height:80px; background:red; border-radius:50%; font-weight:bold; border:4px solid #500;" 
            onmousedown="sendJson({cmd:'buzzer', state:'on'})" 
            onmouseup="sendJson({cmd:'buzzer', state:'off'})">HORN</button>
    </div>
</div>

<script>
    let ws = null;
    let isConnected = false;
    let dragging = false;
    
    const ipInput = document.getElementById('ip');
    const statusText = document.getElementById('status-text');
    const btnConn = document.getElementById('btn-conn');
    const camFeed = document.getElementById('cam-feed');
    const modeDisplay = document.getElementById('mode-display');
    const aiStatus = document.getElementById('ai-status');
    const opMode = document.getElementById('opMode');
    
    const featureBox = document.getElementById('feature-box');
    const speedBox = document.getElementById('speed-box');
    const sysSwitch = document.getElementById('system-switch'); 

    // --- SENSOR MASKING LOGIC (UPDATED: REAL-TIME) ---
    // 1. Default Semua Mati (False)
    const activeSensors = { ll: false, l: false, m: false, r: false, rr: false };

    function toggleSensor(id) {
        // Toggle Logic
        activeSensors[id] = !activeSensors[id];
        
        // Update UI Tombol
        const btn = document.getElementById('s-' + id);
        if (activeSensors[id]) btn.classList.add('active');
        else btn.classList.remove('active');

        // [LIVE UPDATE] Kirim ke Python saat itu juga jika terhubung
        if (isConnected) {
            sendJson({ 
                cmd: "set_ai_mode", 
                mode: "avoid_hybrid", // Pastikan tetap di mode hybrid
                config: activeSensors
            });
        }
    }

    function triggerLineAvoid(btnElement) {
        if (!isConnected) return alert("Connect first!");
        
        // Masuk ke Mode Hybrid (Default config = semua false/mati sampai user klik tombol kecil)
        sendJson({ 
            cmd: "set_ai_mode", 
            mode: "avoid_hybrid",
            config: activeSensors 
        });
        
        highlightBtn(btnElement);
    }
    // --------------------------------------------------

    function toggleMainConnect() {
        if (!isConnected) connectWebSocket();
        else disconnectWebSocket();
    }

    function changeMode() {
        if (isConnected) {
            disconnectWebSocket();
            setTimeout(connectWebSocket, 500);
        }
        updateUI(opMode.value);
    }

    function updateUI(path) {
        featureBox.style.display = "none";
        speedBox.style.display = "none";
        document.querySelectorAll('.ai-grid').forEach(el => el.style.display = 'none');
        document.getElementById('panel-single').style.display = 'none';
        
        sysSwitch.checked = false;
        document.getElementById('switch-txt').innerText = "SYSTEM OFF";
        document.querySelectorAll('.btn-ai').forEach(b => b.classList.remove('active'));

        if (path === "/ws/control") {
            speedBox.style.display = "block";
        } else {
            featureBox.style.display = "block";
            
            if (path === "/ws/avoid") document.getElementById('panel-avoid').style.display = "grid";
            
            else if (path === "/ws/tracking") {
                document.getElementById('panel-tracking').style.display = "grid";
                const btnNone = document.getElementById('btn-track-none');
                if(btnNone) btnNone.classList.add('active');
            }
            else if (path === "/ws/recognitionControl") document.getElementById('panel-recog').style.display = "grid";
            else if (path === "/ws/objectDetection") document.getElementById('panel-detect').style.display = "grid";
            else if (path === "/ws/autoPilot" || path === "/ws/qr") {
                document.getElementById('panel-single').style.display = "block";
            }
        }
    }

    function connectWebSocket() {
        const ip = ipInput.value;
        const path = opMode.value;
        const url = `ws://${ip}:8000${path}`;

        statusText.innerText = "CONNECTING...";
        ws = new WebSocket(url);

        ws.onopen = () => {
            isConnected = true;
            statusText.innerText = "ONLINE";
            statusText.style.color = "#0f0";
            btnConn.innerText = "DISCONNECT";
            btnConn.style.background = "#550000";
            modeDisplay.innerText = opMode.options[opMode.selectedIndex].text.toUpperCase();
            
            updateUI(path); 
            camFeed.src = `http://${ip}:8000/video_feed?t=${new Date().getTime()}`;
            camFeed.style.display = "block";
            document.getElementById('placeholder-text').style.display = "none";
        };

        ws.onmessage = (evt) => {
            try {
                const data = JSON.parse(evt.data);
                if (data.status === "active") {
                    aiStatus.innerText = "RUNNING: " + data.mode.toUpperCase();
                    aiStatus.style.display = "block";
                } else if (data.status === "stopped") {
                    aiStatus.style.display = "none";
                }
            } catch(e){}
        };

        ws.onclose = disconnectWebSocket;
        ws.onerror = disconnectWebSocket;
    }

    function disconnectWebSocket() {
        isConnected = false;
        if(ws) ws.close();
        ws = null;
        statusText.innerText = "DISCONNECTED";
        statusText.style.color = "red";
        btnConn.innerText = "CONNECT";
        btnConn.style.background = "#004400";
        camFeed.src = "";
        camFeed.style.display = "none";
        document.getElementById('placeholder-text').style.display = "block";
        aiStatus.style.display = "none";
        updateUI("/ws/control");
    }

    function toggleSystem(checkbox) {
        if (!isConnected) {
            checkbox.checked = false; 
            return alert("Connect first!");
        }
        const label = document.getElementById('switch-txt');
        if (checkbox.checked) {
            label.innerText = "SYSTEM ON";
            label.style.color = "var(--primary)";
            sendJson({ cmd: "set_ai_mode", mode: "start" });
        } else {
            label.innerText = "SYSTEM OFF";
            label.style.color = "#aaa";
            sendJson({ cmd: "set_ai_mode", mode: "stop" }); 
        }
    }

    function triggerAI(modeName, btnElement) {
        if (!isConnected) return alert("Connect first!");
        sendJson({ cmd: "set_ai_mode", mode: modeName });
        highlightBtn(btnElement);
    }

    function triggerColor(colorName, btnElement) {
        if (!isConnected) return alert("Connect first!");
        sendJson({ cmd: "set_ai_mode", mode: "color_follow", color: colorName });
        highlightBtn(btnElement);
    }

    function triggerColorTrack(colorName, btnElement) {
        if (!isConnected) return alert("Connect first!");
        sendJson({ cmd: "set_ai_mode", mode: "color_track", color: colorName });
        highlightBtn(btnElement);
    }

    function highlightBtn(btnElement) {
        const parent = btnElement.parentElement;
        parent.querySelectorAll('.btn-ai').forEach(b => b.classList.remove('active'));
        btnElement.classList.add('active');
    }

    function sendJson(data) {
        if (ws && ws.readyState === 1) ws.send(JSON.stringify(data));
    }

    // --- JOYSTICK LOGIC ---
    const zone = document.getElementById('zone');
    const knob = document.getElementById('knob');
    
    function handleMove(clientX, clientY) {
        if (!dragging) return;
        const rect = zone.getBoundingClientRect();
        const radius = rect.width / 2;
        let x = clientX - (rect.left + radius);
        let y = clientY - (rect.top + radius);
        
        const dist = Math.sqrt(x*x + y*y);
        const maxDist = radius - 25; 
        if (dist > maxDist) { x = (x / dist) * maxDist; y = (y / dist) * maxDist; }
        
        knob.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
        
        if (opMode.value === "/ws/control") {
            const normX = parseFloat((x / maxDist).toFixed(2));
            const normY = parseFloat((-y / maxDist).toFixed(2));
            const spd = parseInt(document.getElementById('speed').value);
            sendJson({ cmd: "move", x: normX, y: normY, speed: spd });
        }
    }
    
    function endMove() {
        dragging = false;
        knob.style.transform = `translate(-50%, -50%)`;
        if (opMode.value === "/ws/control") sendJson({ cmd: "stop" });
    }
    
    knob.addEventListener('mousedown', () => dragging = true);
    window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
    window.addEventListener('mouseup', endMove);
    
    knob.addEventListener('touchstart', (e) => { dragging = true; e.preventDefault(); });
    window.addEventListener('touchmove', (e) => { if(dragging) { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); } }, {passive: false});
    window.addEventListener('touchend', endMove);
</script>
</body>
</html>
